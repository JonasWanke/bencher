---
title: "Действия GitHub"
description: "Используйте Bencher в Действиях GitHub для непрерывного бенчмаркинга при запросах на вытягивание"
heading: "Как использовать Bencher в Действиях GitHub"
sortOrder: 3
---

import GitHubActions1 from "../../../chunks/how_to/github-actions.1.mdx";
import GitHubActions2 from "../../../chunks/how_to/github-actions.2.mdx";
import GitHubActions3 from "../../../chunks/how_to/github-actions.3.mdx";
import GitHubActions4 from "../../../chunks/how_to/github-actions.4.mdx";
import GitHubActions5 from "../../../chunks/how_to/github-actions.5.mdx";
import GitHubActions6 from "../../../chunks/how_to/github-actions.6.mdx";

<GitHubActions1 />

1. Создайте `workflow` в Действиях GitHub (например: `.github/workflows/benchmark.yml`).
2. Укажите события, при которых должен запускаться `workflow`. Смотрите [документацию Действий GitHub `on`](https://docs.github.com/ru/actions/using-workflows/workflow-syntax-for-github-actions#on) для полного ознакомления. Этот `workflow` запускается **только** при событиях `push` в ветку `main`. Для запуска [при запросах на вытягивание смотрите ниже](#pull-requests).
3. Создайте `job` в Действиях GitHub (например: `benchmark_with_bencher`)
4. Проект должен существовать. Установите флаг `--project` или переменную окружения `BENCHER_PROJECT` для идентификатора проекта или slug. (например: `BENCHER_PROJECT: save-walter-white`)
5. Добавьте `BENCHER_API_TOKEN` как секрет **Репозитория** (например: `Repo -> Settings -> Secrets and variables -> Действия -> Новый секрет репозитория`)
6. API-токен должен существовать. Установите флаг `--token` или переменную окружения `BENCHER_API_TOKEN` для API токена. (например: `BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}`)
7. Необязательно: Установите флаг `--adapter` или переменную окружения `BENCHER_ADAPTER` для желаемого имени адаптера. Если это не установлено, будет использован `magic` адаптер. Смотрите [адаптеры для бенчмарк-процессов](/docs/ru/explanation/adapters) для полного ознакомления. (например: `BENCHER_ADAPTER: json`)
8. Необязательно: Установите флаг `--testbed` или переменную окружения `BENCHER_TESTBED` для идентификатора или слага тестовой среды. Тестовая среда **должна** существовать. Если это не установлено, будет использована тестовая среда `localhost`. (например: `BENCHER_TESTBED: ubuntu-latest`)
9. Используйте `checkout` для вашего исходного кода. (например: `uses: actions/checkout@v3`)
10. Установите Bencher CLI используя [GitHub Action](https://github.com/marketplace/actions/bencher-cli). (например: `uses: bencherdev/bencher@main`)
11. [Отслеживайте ваши бенчмарки](/docs/ru/how-to/track-benchmarks) с помощью подкоманды CLI <code><a href="/docs/ru/explanation/bencher-run">bencher run</a></code>:
    1. Существует несколько вариантов установки ветки проекта. Смотрите [выбор ветки](/docs/ru/how-to/branch-selection) для полного ознакомления. Предложенная команда использует [стандартные переменные окружения Действий GitHub](https://docs.github.com/ru/actions/learn-github-actions/variables#default-environment-variables) и пытается:
        1. Использовать текущие данные ветки, если они уже существуют. (например: `--if-branch "$GITHUB_REF_NAME"`)
        2. Создать клон данных и пороговых значений целевой ветки запроса на вытягивание, если они уже существуют. (например: `--else-if-branch "$GITHUB_BASE_REF"`)
        3. В противном случае, создать клон данных и пороговых значений ветки `main`. (например: `--else-if-branch main`)
    2. Установите команду на отказ, если генерируется Предупреждение. Для генерации Предупреждения должен уже существовать [Порог](/docs/ru/explanation/thresholds). (например: `--err`)
    3. Установите токен аутентификации API GitHub (например: `--github-actions ${{ secrets.GITHUB_TOKEN }}`). Когда этот параметр установлен как часть запроса на вытягивание, тогда результаты будут добавлены к запросу на вытягивание в виде комментария. Предложенная команда использует [переменную окружения `GITHUB_TOKEN` Действий GitHub](https://docs.github.com/ru/actions/security-guides/automatic-token-authentication).
    4. Запустите ваши бенчмарки и сгенерируйте Отчет из результатов. (например: `"bencher mock"`)

<br/>

## Запросы на вытягивание

Чтобы отловить регрессию производительности в запросах на вытягивание, вам потребуется запускать ваше бенчмарки при запросах на вытягивание.
Если вы хотите получать только запросы на вытягивание из веток в том же репозитории, вы можете просто изменить пример выше, чтобы также запускать `on` `pull_request` события.

<GitHubActions2 />

Важно ограничить запуск при `push` **только** для выбранных веток (например: `main`)
чтобы избежать двойного запуска при внесении изменений в ветки запросов на вытягивание!
Вновь, это решение работает только если все запросы на вытягивание из **того же** репозитория.

Также может быть полезным ограничить запуски только после добавления определенной метки (например: `benchmark`):

<GitHubActions3 />

Если вы собираетесь принимать запросы на вытягивание из форков, как это часто бывает в публичных проектах с открытым исходным кодом,
тогда вам потребуется немного иначе обрабатывать запросы на вытягивание.
По соображениям безопасности секреты, такие как ваш `BENCHER_API_TOKEN` и `GITHUB_TOKEN`, не доступны в Действиях GitHub для запросов на вытягивание из форков.
Это означает, что если внешний участник откроет запрос на вытягивание из форка, приведенный выше пример работать не будет.
Для запросов на вытягивание из форков существуют три варианта:

<ul>
  <li>[Бенчмаркинг ветки запроса на вытягивание из целевой ветки](#benchmark-pr-branch-from-target-branch)</li>
  <li>[Бенчмаркинг ветки запроса на вытягивание из целевой ветки с обязательными рецензентами](#benchmark-pr-branch-from-target-branch-with-required-reviewers)</li>
  <li>[Кэширование результатов бенчмаркинга запроса на вытягивание и их загрузка из основной ветки](#cache-pr-benchmark-results)</li>
</ul>

### Бенчмаркинг ветки запроса на вытягивание из целевой ветки

<GitHubActions4 />

1. Запустите [событие `pull_request_target`](https://docs.github.com/ru/actions/using-workflows/events-that-trigger-workflows#pull_request_target).
1. Выполните `checkout` ветки запроса на вытягивание.
1. Запустите и отследите бенчмарки вашего запроса на вытягивание, используя `bencher run` напрямую.

Это работает, потому что `pull_request_target` выполняется в контексте целевой ветки запроса на вытягивание,
где доступны секреты, как ваш `BENCHER_API_TOKEN` и `GITHUB_TOKEN`.
Следовательно, этот `workflow` будет выполняться только если он существует в целевой ветке.
Избегайте установки любых секретов как переменные окружения, таких как `BENCHER_API_TOKEN`.
Вместо этого явно передайте API токен в `bencher run` (например: `--token ${{ secrets.BENCHER_API_TOKEN }}`).
См. эту [заметку Безопасной Лаборатории GitHub](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)
и [эту статью в блоге](https://nathandavison.com/blog/github-actions-and-the-threat-of-malicious-pull-requests)
о предотвращении злонамеренных запросов на вытягивание для полного ознакомления.

### Бенчмаркинг ветки запроса на вытягивание из целевой ветки с обязательными рецензентами

<GitHubActions5 />

1. Запустите [событие `pull_request_target`](https://docs.github.com/ru/actions/using-workflows/events-that-trigger-workflows#pull_request_target).
1. Если запрос на вытягивание `internal`, тогда продолжите; если запрос `external`, подождите обязательного ревью.
1. Выполните `checkout` ветки запроса на вытягивание.
1. Запустите и отследите бенчмарки вашего запроса на вытягивание, используя `bencher run` напрямую.

Этот вариант точно такой же как [предыдущий вариант](#benchmark-pr-branch-from-target-branch)
за исключением того, что он `needs` одобрения от обязательного рецензента перед каждым запуском.
Чтобы настроить это, вам нужно [создать два Действия GitHub сред](https://docs.github.com/ru/actions/deployment/targeting-different-environments/using-environments-for-deployment#using-an-environment)
(например: `Repo -> Settings -> Environments -> Новая среда`).
Для `internal` среды не требуется установка `правил защиты развертывания`.
Однако, для `external` среды `обязательными рецензентами` должны быть те, кто доверен для рецензии запроса на вытягивание перед бенчмаркингом.

Следует отметить, что это отличается от вышеупомянутого варианта с меткой для внутренних запросов на вытягивание.
Решение, основанное на метках запустит _любую_ будущую работу после прикрепления метки.
Это может быть полезно, если вы хотите провести бенчмаркинг только определенных запросов на вытягивание.
Однако, метки не должны рассматриваться в качестве меры безопасности.

Одобрение на основе метки может быть ограничено одним запуском, ограничив `on: pull_request_target` до `types: [labeled]`.
Тогда вам придется удалять и снова прикреплять метку для каждого последующего одобрения.
На этом этапе вы просто повторяете `правила защиты развертывания` выше и загромождаете историю ваших запросов на вытягивание.

### Кэширование результатов бенчмаркинга запроса на вытягивание

<GitHubActions6 />

1. Запустите бенчмарки вашего запроса на вытягивание при событиях `pull_request`.
1. Сохраните результаты бенчмарков вашего запроса на вытягивание в файл и загрузите их как артефакт.
1. Загрузите событие запроса на вытягивание как артефакт.
1. Свяжите этот процесс с [событием `workflow_run`](https://docs.github.com/ru/actions/using-workflows/events-that-trigger-workflows#workflow_run).
1. Извлеките необходимые данные из кэшированного события запроса на вытягивание.
1. Отследите кэшированные результаты бенчмарков запроса на вытягивание с помощью `bencher run`.

Это работает, потому что `workflow_run` запускается в контексте основной ветки репозитория,
где доступны секреты, как ваш `BENCHER_API_TOKEN` и `GITHUB_TOKEN`.
Следовательно, эти процессы будут работать только если они существуют в основной ветке.
См. [использование данных из запускающего процесса](https://docs.github.com/ru/actions/using-workflows/events-that-trigger-workflows#using-data-from-the-triggering-workflow) для полного ознакомления.
Номер запроса на вытягивание, основная ветка и целевая ветка, используемые в начальном процессе, должны быть явно переданы, поскольку они недоступны в `workflow_run`.

<br/>
<br/>

> 🐰 Поздравляем! Вы узнали, как использовать Bencher в Действиях GitHub! 🎉

<br/>

<h2><a href="/docs/ru/explanation/benchmarking">Продолжайте: Обзор бенчмаркинга ➡</a></h2>