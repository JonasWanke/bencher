---
title: "GitHub Actions"
description: "Используйте Bencher в GitHub Actions для непрерывного бенчмаркинга при создании pull requests"
heading: "Как использовать Bencher в GitHub Actions"
sortOrder: 3
---

import GitHubActions1 from "../../../chunks/how_to/github-actions.1.mdx";
import GitHubActions2 from "../../../chunks/how_to/github-actions.2.mdx";
import GitHubActions3 from "../../../chunks/how_to/github-actions.3.mdx";
import GitHubActions4 from "../../../chunks/how_to/github-actions.4.mdx";

<GitHubActions1 />

1. Создайте `workflow` GitHub Actions (пример: `.github/workflows/benchmark.yml`).
2. Укажите события, при которых должен запускаться `workflow`. См. [документацию GitHub Actions `on`](https://docs.github.com/ru/actions/using-workflows/workflow-syntax-for-github-actions#on) для полного обзора. Этот `workflow` запускается **только** при событиях `push` в ветку `main`. Для запуска [при Pull Requests см. раздел ниже](#pull-requests).
3. Создайте `job` GitHub Actions (пример: `benchmark_with_bencher`).
4. Проект должен уже существовать. Установите флаг `--project` или переменную окружения `BENCHER_PROJECT` на slug или UUID проекта. (пример: `BENCHER_PROJECT: save-walter-white`).
5. Добавьте `BENCHER_API_TOKEN` в секреты Вашего **репозитория** (пример: `https://github.com/USERNAME/REPO/settings/secrets/actions`).
6. Токен API должен уже существовать. Установите флаг `--token` или переменную окружения `BENCHER_API_TOKEN` на токен API. (пример: `BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}`).
7. Опционально: установите флаг `--adapter` или переменную окружения `BENCHER_ADAPTER` на желаемое имя адаптера. Если это не установлено, то будет использован адаптер `magic`. См. [адаптеры бенчмарк-тула](/docs/ru/explanation/adapters) для полного обзора. (пример: `BENCHER_ADAPTER: json`).
8. Опционально: установите флаг `--testbed` или переменную окружения `BENCHER_TESTBED` на slug или UUID тестового стенда. Тестовый стенд **должен** уже существовать. Если это не установлено, то будет использован тестовый стенд `localhost`. (пример: `BENCHER_TESTBED: ubuntu-latest`).
9. Осуществите checkout исходного кода. (пример: `uses: actions/checkout@v3`).
10. Установите CLI Bencher с использованием [GitHub Action](https://github.com/marketplace/actions/bencher-cli). (пример: `uses: bencherdev/bencher@main`).
11. [Отследите свои бенчмарки](/docs/ru/how-to/track-benchmarks) с помощью подкоманды CLI <code><a href="/docs/ru/explanation/bencher-run">bencher run</a></code>:
    1. Для установки ветки проекта есть несколько опций. См. [выбор ветки](/docs/ru/how-to/branch-selection) для полного обзора. Представленная команда использует [стандартные переменные окружения GitHub Action](https://docs.github.com/ru/actions/learn-github-actions/variables#default-environment-variables) и пытается:
        1. Использовать данные текущей ветки, если они уже существуют. (пример: `--if-branch "$GITHUB_REF_NAME"`)
        2. Создать клон данных и порогов целевой ветки PR, если они уже существуют. (пример: `--else-if-branch "$GITHUB_BASE_REF"`)
        3. В противном случае создать клон данных и порогов ветки `main`. (пример: `--else-if-branch main`)
    2. Установите команду на сбой, если создано предупреждение (Alert). Для генерации предупреждения должен уже существовать [Threshold (порог)](/docs/ru/explanation/thresholds). (пример: `--err`)
    3. Установите токен аутентификации GitHub API (пример: `--github-actions ${{ secrets.GITHUB_TOKEN }}`). Когда этот параметр установлен в рамках pull request, то результаты будут добавлены в pull request в виде комментария. Представленная команда использует [переменную окружения `GITHUB_TOKEN` GitHub Actions](https://docs.github.com/ru/actions/security-guides/automatic-token-authentication).
    4. Запустите свои бенчмарки и создайте отчет из результатов. (пример: `"bencher mock"`)

<br/>

## Pull Requests

Чтобы отслеживать регрессию производительности в pull requests, вам нужно запускать свои бенчмарки на PR.
Если вы ожидаете только PR от веток внутри одного и того же репозитория, то вы можете просто изменить пример выше, чтобы также запускать `on` `pull_request` события.

<GitHubActions2 />

Важно ограничить запуск при `push` **только** для выбранных веток (например: `main`),
чтобы предотвратить двойной запуск при пуше в ветки PR!
Опять, это решение работает только если все PR создаются в рамках одного и того же **репозитория**.

Если вы планируете принимать pull requests из форков, как это часто бывает в открытых проектах с открытым исходным кодом,
вам придется обрабатывать вещи немного иначе.
По соображениям безопасности секреты, такие как `BENCHER_API_TOKEN` и `GITHUB_TOKEN`, недоступны в GitHub Actions для PR из форков.
То есть, если внешний участник открывает PR из форка, приведенный выше пример не сработает.
Есть два варианта для PR из форков:

<ul>
  <li>[Бенчмаркинг PR ветки от целевой ветки](#benchmark-pr-branch-from-target-branch)</li>
  <li>[Кэширование результатов бенчмарка PR и загрузка из основного бранча](#cache-pr-benchmark-results)</li>
</ul>

### Бенчмаркинг PR Ветки от Целевой Ветки

1. Срабатывание [на событие `pull_request_target`](https://docs.github.com/ru/actions/using-workflows/events-that-trigger-workflows#pull_request_target).
2. Checkout ветки PR.
3. Запустите и отследите бенчмарки PR с помощью `bencher run` напрямую.

Это работает потому, что `pull_request_target` работает в контексте целевой ветки запроса на pull, 
где секреты, такие как `BENCHER_API_TOKEN` и `GITHUB_TOKEN`, доступны.
Поэтому этот `workflow` будет запускаться только если он существует на целевом бранче.
Избегайте установки секретов в качестве переменных окружения, таких как `BENCHER_API_TOKEN`.
Вместо этого явно передавайте токен API в `bencher run` (например: `--token ${{ secrets.BENCHER_API_TOKEN }}`).
См. эту [работу GitHub Security Lab](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)
и [этот блоговый пост](https://nathandavison.com/blog/github-actions-and-the-threat-of-malicious-pull-requests)
о предотвращении вредоносных pull requests для полного обзора.

<GitHubActions3 />

### Кэширование Результатов Бенчмарка PR

1. Запустите бенчмарки PR на событиях `pull_request`.
1. Сохраните результаты бенчмарка PR в файл и загрузите их как элемент.
1. Загрузите событие PR в качестве элемента.
1. Сопоставьте этот `workflow` с событием [`workflow_run`](https://docs.github.com/ru/actions/using-workflows/events-that-trigger-workflows#workflow_run).
1. Извлеките необходимые данные из кэшированного события PR.
1. Отслеживайте результаты кэшированного бенчмарка PR с помощью `bencher run`.

Это работает, потому что `workflow_run` работает в контексте основного бранча репозитория,
где секреты, такие как `BENCHER_API_TOKEN` и `GITHUB_TOKEN`, доступны.
Поэтому эти `workflow` будут запускаться только если они существуют на основном бранче.
См. [использование данных из вызывающего `workflow`](https://docs.github.com/ru/actions/using-workflows/events-that-trigger-workflows#using-data-from-the-triggering-workflow) для полного обзора.
Номер pull request, head branch и base branch, используемые в начальном workflow, должны быть явно переданы, так как они недоступны внутри `workflow_run`.

<GitHubActions4 />

<br/>
<br/>

> 🐰 Поздравляем! Вы научились использовать Bencher в GitHub Actions! 🎉

<br/>

<h2><a href="/docs/ru/explanation/benchmarking">Продолжайте изучать: Обзор Бенчмаркинга ➡</a></h2>