---
title: "GitHub Actions"
description: "Use o Bencher nas GitHub Actions para benchmarking cont√≠nuo em pull requests"
heading: "Como usar o Bencher nas GitHub Actions"
sortOrder: 3
---

import GitHubActions1 from "../../../chunks/how_to/github-actions.1.mdx";
import GitHubActions2 from "../../../chunks/how_to/github-actions.2.mdx";
import GitHubActions3 from "../../../chunks/how_to/github-actions.3.mdx";
import GitHubActions4 from "../../../chunks/how_to/github-actions.4.mdx";
import GitHubActions5 from "../../../chunks/how_to/github-actions.5.mdx";
import GitHubActions6 from "../../../chunks/how_to/github-actions.6.mdx";

<GitHubActions1 />

1. Crie um `workflow` do GitHub Actions (ex: `.github/workflows/benchmark.yml`).
2. Especifique os eventos em que o workflow dever√° ser executado `on`. Veja a [documenta√ß√£o `on` do GitHub Actions](https://docs.github.com/pt/actions/using-workflows/workflow-syntax-for-github-actions#on) para uma vis√£o geral completa. Este workflow √© executado **somente** em eventos `push` para a branch `main`. Para executar [em Pull Requests, veja a se√ß√£o abaixo](#pull-requests).
3. Crie um `job` do GitHub Actions (ex: `benchmark_with_bencher`)
4. O Projeto j√° deve existir. Defina a flag `--project` ou a vari√°vel de ambiente `BENCHER_PROJECT` para o slug do Projeto ou UUID. (ex: `BENCHER_PROJECT: save-walter-white`)
5. Adicione `BENCHER_API_TOKEN` como um segredo do **Reposit√≥rio** (ex: `Repo -> Settings -> Secrets and variables -> Actions -> New repository secret`)
6. O token API j√° deve existir. Defina a flag `--token` ou a vari√°vel de ambiente `BENCHER_API_TOKEN` para o token API. (ex: `BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}`)
7. Opcional: Defina a flag `--adapter` ou a vari√°vel de ambiente `BENCHER_ADAPTER` para o nome do adaptador desejado. Se isso n√£o for definido, ent√£o o adaptador `magic` ser√° usado. Veja [adaptadores de ambiente de teste de benchmark](/docs/pt/explanation/adapters) para uma vis√£o geral completa. (ex: `BENCHER_ADAPTER: json`)
8. Opcional: Defina a flag `--testbed` ou a vari√°vel de ambiente `BENCHER_TESTBED` para o slug da testbed ou UUID. A Testbed **deve** j√° existir. Se isso n√£o for definido, ent√£o a Testbed `localhost` ser√° usada. (ex: `BENCHER_TESTBED: ubuntu-latest`)
9. Fa√ßa o checkout do seu c√≥digo fonte. (ex: `uses: actions/checkout@v3`)
10. Instale a CLI Bencher usando o [GitHub Action](https://github.com/marketplace/actions/bencher-cli). (ex: `uses: bencherdev/bencher@main`)
11. [Rastreie seus benchmarks](/docs/pt/how-to/track-benchmarks) com o subcomando CLI <code><a href="/docs/pt/explanation/bencher-run">bencher run</a></code>:
    1. Existem v√°rias op√ß√µes para definir a branch do projeto. Veja [sele√ß√£o de branch](/docs/pt/how-to/branch-selection) para uma vis√£o geral completa. O comando fornecido usa [vari√°veis de ambiente padr√£o da GitHub Action](https://docs.github.com/pt/actions/learn-github-actions/variables#default-environment-variables) e tenta:
        1. Usar os dados da branch atual, se j√° existirem. (ex: `--if-branch "$GITHUB_REF_NAME"`)
        2. Criar um clone dos dados e limiares da branch de destino do PR, se j√° existirem. (ex: `--else-if-branch "$GITHUB_BASE_REF"`)
        3. Caso contr√°rio, crie um clone dos dados e limites da branch `main`. (ex: `--else-if-branch main`)
    2. Defina o comando para falhar se um Alerta for gerado. Para que um Alerta seja gerado, um [Limiar](/docs/pt/explanation/thresholds) deve j√° existir. (ex: `--err`)
    3. Defina o token de autentica√ß√£o da API do GitHub (ex: `--github-actions ${{ secrets.GITHUB_TOKEN }}`). Quando esta op√ß√£o √© definida como parte de uma solicita√ß√£o pull, os resultados ser√£o adicionados √† solicita√ß√£o pull como um coment√°rio. O comando fornecido usa [a vari√°vel de ambiente `GITHUB_TOKEN` do GitHub Actions](https://docs.github.com/pt/actions/security-guides/automatic-token-authentication).
    4. Execute seus benchmarks e gere um Relat√≥rio a partir dos resultados. (ex: `"bencher mock"`)

<br/>

## Pull Requests

Para pegar regress√£o de desempenho em Pull Requests, voc√™ precisar√° executar seus benchmarks em PRs.
Se voc√™ espera ter PRs apenas de branchs no mesmo reposit√≥rio, voc√™ pode simplesmente modificar o exemplo acima para tamb√©m executar `on` em eventos de `pull_request`.

<GitHubActions2 />

√â importante limitar a execu√ß√£o em `push` **somente** para as branchs selecionadas (ex: `main`) 
para evitar que pushes para branchs de PR sejam executados duas vezes!
Novamente, essa solu√ß√£o s√≥ funciona se todos os PRs forem do **mesmo** reposit√≥rio.

Tamb√©m pode ser bom limitar as execu√ß√µes apenas ap√≥s uma determinada etiqueta ter sido adicionada (ex: `benchmark`):

<GitHubActions3 />

Se voc√™ planeja aceitar Pull Requests de forks, como √© comum em projetos de c√≥digo aberto,
ent√£o voc√™ precisar√° lidar com as coisas de maneira um pouco diferente.
Por raz√µes de seguran√ßa, segredos como o `BENCHER_API_TOKEN` e o `GITHUB_TOKEN` n√£o est√£o dispon√≠veis nas GitHub Actions para PRs de forks.
Ou seja, se um contribuinte externo abrir um PR a partir de um fork, o exemplo acima n√£o funcionar√°.
H√° tr√™s op√ß√µes para PRs de forks:

<ul>
  <li>[Benchmark da branch PR a partir da branch de destino](#benchmark-pr-branch-from-target-branch)</li>
  <li>[Benchmark da branch PR a partir da branch de destino com revisores obrigat√≥rios](#benchmark-pr-branch-from-target-branch-with-required-reviewers)</li>
  <li>[Resultados do benchmark da branch PR em cache e upload a partir da branch padr√£o](#cache-pr-benchmark-results)</li>
</ul>

### Benchmark da Branch PR a partir da Branch de Destino

<GitHubActions4 />

1. Acione [no evento `pull_request_target`](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#pull_request_target).
1. Fa√ßa o checkout da branch PR.
1. Execute e rastreie seus benchmarks PR usando `bencher run` diretamente.

Isso funciona porque `pull_request_target` √© executado no contexto da branch de destino do pull request,
onde segredos como o `BENCHER_API_TOKEN` e o `GITHUB_TOKEN` est√£o dispon√≠veis.
Portanto, esse workflow s√≥ ser√° executado se existir na branch de destino.
N√£o defina nenhum segredo como vari√°veis de ambiente, tais como `BENCHER_API_TOKEN`.
Passe explicitamente o token API para `bencher run` (ex: `--token ${{ secrets.BENCHER_API_TOKEN }}`).
Veja este [artigo do GitHub Security Lab](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)
e [este post de blog](https://nathandavison.com/blog/github-actions-and-the-threat-of-malicious-pull-requests)
sobre preven√ß√£o de pedidos pwn para uma vis√£o geral completa.

### Benchmark da Branch PR a partir da Branch de Destino com Revisores Obrigat√≥rios 

<GitHubActions5 />

1. Acione [no evento `pull_request_target`](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#pull_request_target).
1. Se o PR for `interno`, continue; se o PR for `externo`, espere uma revis√£o obrigat√≥ria.
1. Fa√ßa o checkout da branch PR.
1. Execute e rastreie seus benchmarks PR usando `bencher run` diretamente.

Esta op√ß√£o √© exatamente a mesma que [a op√ß√£o anterior](#benchmark-pr-branch-from-target-branch)
exceto que ela `precisa` da aprova√ß√£o de um Revisor Obrigat√≥rio antes de cada execu√ß√£o.
Para configurar isso, voc√™ precisa [criar dois Ambientes do GitHub Action](https://docs.github.com/pt/actions/deployment/targeting-different-environments/using-environments-for-deployment#using-an-environment)
(ex: `Repo -> Settings -> Environments -> New environment`).
O ambiente `interno` n√£o requer `Regras de prote√ß√£o de deployment`.
No entanto, o ambiente `externo` deve ter `Revisores obrigat√≥rios` definidos como aqueles confi√°veis para revisar um PR antes do benchmarking.

Note que isso √© diferente da op√ß√£o de tag listada acima para PRs internos.
A solu√ß√£o baseada em tag executar√° _qualquer_ trabalho futuro depois de ser marcada.
Isso pode ser √∫til se voc√™ s√≥ quer fazer benchmark de certos PRs.
No entanto, as tags n√£o devem ser vistas como uma medida de seguran√ßa.

A aprova√ß√£o baseada em tag pode ser limitada a uma √∫nica execu√ß√£o restringindo o `on: pull_request_target` a `types: [labeled]`.
Voc√™ teria ent√£o que remover e retag da PR para cada aprova√ß√£o subsequente.
Nesse ponto, voc√™ est√° apenas recriando as `Regras de prote√ß√£o de implanta√ß√£o` acima e estragando o hist√≥rico de seu PR.

### Cache dos Resultados do Benchmark PR 

<GitHubActions6 />

1. Execute seus benchmarks PR em eventos `pull_request`.
1. Salve os resultados dos benchmarks PR em um arquivo e fa√ßa upload deles como um artefato.
1. Fa√ßa upload do evento PR como um artefato.
1. Encadeie esse fluxo de trabalho com [o evento `workflow_run`](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#workflow_run).
1. Extraia os dados necess√°rios do evento PR em cache.
1. Rastreie os resultados do benchmark PR em cache com `bencher run`.

Isso funciona porque a `workflow_run` √© executada no contexto da branch padr√£o do reposit√≥rio,
onde segredos como o `BENCHER_API_TOKEN` e o `GITHUB_TOKEN` est√£o dispon√≠veis.
Portanto, esses fluxos de trabalho s√≥ ser√£o executados se existirem na branch padr√£o.
Veja [usando dados do workflow desencadeador](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#using-data-from-the-triggering-workflow) para uma vis√£o geral completa.
O n√∫mero da pull request, branch head e branch base usadas no workflow inicial devem ser passadas explicitamente, pois n√£o est√£o dispon√≠veis em `workflow_run`.

<br/>
<br/>

> üê∞ Parab√©ns! Voc√™ aprendeu como usar o Bencher nas GitHub Actions! üéâ

<br/>

<h2><a href="/docs/pt/explanation/benchmarking">Continue: Vis√£o Geral do Benchmarking ‚û°</a></h2>
