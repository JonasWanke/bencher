---
title: "GitHub Actions"
description: "Use o Bencher nas GitHub Actions para benchmarking cont√≠nuo em pull requests"
heading: "Como usar o Bencher nas GitHub Actions"
sortOrder: 3
---

import GitHubActions1 from "../../../chunks/how_to/github-actions.1.mdx";
import GitHubActions2 from "../../../chunks/how_to/github-actions.2.mdx";
import GitHubActions3 from "../../../chunks/how_to/github-actions.3.mdx";
import GitHubActions4 from "../../../chunks/how_to/github-actions.4.mdx";

<GitHubActions1 />

1. Crie uma `workflow` nas GitHub Actions (ex: `.github/workflows/benchmark.yml`).
2. Especifique os eventos que a workflow deve executar `on`. Veja a [documenta√ß√£o 'on' do GitHub Actions](https://docs.github.com/pt/actions/using-workflows/workflow-syntax-for-github-actions#on) para uma vis√£o completa. Esta workflow √© executada **somente** em eventos `push` para a branch `main`. Para executar [em Pull Requests veja a se√ß√£o abaixo](#pull-requests).
3. Crie um `job` nas GitHub Actions (ex: `benchmark_with_bencher`).
4. O Projeto j√° deve existir. Defina o flag `--project` ou a vari√°vel de ambiente `BENCHER_PROJECT` para o slug ou UUID do Projeto. (ex: `BENCHER_PROJECT: save-walter-white`)
5. Adicione `BENCHER_API_TOKEN` aos segredos do seu **Reposit√≥rio** (ex: `https://github.com/USERNAME/REPO/settings/secrets/actions`)
6. O token da API j√° deve existir. Defina o flag `--token` ou a vari√°vel de ambiente `BENCHER_API_TOKEN` para o token da API. (ex: `BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}`)
7. Opcional: Defina o flag `--adapter` ou a vari√°vel de ambiente `BENCHER_ADAPTER` para o nome do adaptador desejado. Se isso n√£o for definido, ent√£o o Adaptador `magic` ser√° usado. Veja [adaptadores de benchmark](/docs/pt/explanation/adapters) para uma vis√£o completa. (ex: `BENCHER_ADAPTER: json`)
8. Opcional: Defina o flag `--testbed` ou a vari√°vel de ambiente `BENCHER_TESTBED` para o slug ou UUID do Testbed. O Testbed **deve** j√° existir. Se isso n√£o for definido, ent√£o o Testbed `localhost` ser√° usado. (ex: `BENCHER_TESTBED: ubuntu-latest`)
9. Fa√ßa o checkout do seu c√≥digo-fonte. (ex: `uses: actions/checkout@v3`)
10. Instale o Bencher CLI usando a [A√ß√£o do GitHub](https://github.com/marketplace/actions/bencher-cli). (ex: `uses: bencherdev/bencher@main`)
11. [Acompanhe seus benchmarks](/docs/pt/how-to/track-benchmarks) com o subcomando <code><a href="/docs/pt/explanation/bencher-run">bencher run</a></code>:
    1. Existem v√°rias op√ß√µes para definir a branch do projeto. Veja [sele√ß√£o de branch](/docs/pt/how-to/branch-selection) para uma vis√£o completa. O comando fornecido usa [vari√°veis de ambiente padr√£o das GitHub Actions](https://docs.github.com/pt/actions/learn-github-actions/variables#default-environment-variables) e tenta:
        1. Usar os dados da branch atual se j√° existirem. (ex: `--if-branch "$GITHUB_REF_NAME"`)
        2. Criar um clone dos dados e limites da branch alvo do PR se existirem. (ex: `--else-if-branch "$GITHUB_BASE_REF"`)
        3. Caso contr√°rio, crie um clone dos dados e limites da branch `main`. (ex: `--else-if-branch main`)
    2. Defina o comando para falhar se um Alerta for gerado. Para que um Alerta seja gerado, um [Limite](/docs/pt/explanation/thresholds) j√° deve existir. (ex: `--err`)
    3. Defina o token de autentica√ß√£o da API do GitHub (ex: `--github-actions ${{ secrets.GITHUB_TOKEN }}`). Quando essa op√ß√£o √© definida como parte de uma pull request, os resultados ser√£o adicionados √† pull request como um coment√°rio. O comando fornecido usa [a vari√°vel de ambiente `GITHUB_TOKEN` do GitHub Actions](https://docs.github.com/pt/actions/security-guides/automatic-token-authentication).
    4. Execute seus benchmarks e gere um Relat√≥rio a partir dos resultados. (ex: `"bencher mock"`)

<br/>

## Pull Requests

Para detectar a regress√£o de performance em Pull Requests, voc√™ precisar√° executar seus benchmarks em PRs.
Se voc√™ espera apenas ter PRs de branches dentro do mesmo reposit√≥rio, ent√£o voc√™ pode simplesmente modificar o exemplo acima para tamb√©m executar `on` em eventos `pull_request`.

<GitHubActions2 />

√â importante limitar a execu√ß√£o `on` `push` **apenas** para as branches selecionadas (ex: `main`)
para evitar que os pushes para as branches PR sejam executados duas vezes!
Novamente, esta solu√ß√£o s√≥ funciona se todas as PRs s√£o do **mesmo** reposit√≥rio.

Se voc√™ planeja aceitar Pull Requests de forks, como √© comum em projetos open source p√∫blicos,
ent√£o voc√™ precisa lidar com as coisas de maneira um pouco diferente. 
Por motivos de seguran√ßa, segredos como `BENCHER_API_TOKEN` e `GITHUB_TOKEN` n√£o est√£o dispon√≠veis nas GitHub Actions para PRs de forks. 
Ou seja, se um contribuidor externo abrir uma PR a partir de um fork, o exemplo acima n√£o funcionar√°. 
Existem duas op√ß√µes para PRs de forks:

<ul>
  <li>[Benchmark da branch PR a partir da branch alvo](#benchmark-pr-branch-from-target-branch)</li>
  <li>[Armazenar resultados da benchmark da branch PR e carreg√°-los a partir da branch padr√£o](#cache-pr-benchmark-results)</li>
</ul>

### Benchmark da Branch PR a partir da Branch Alvo

1. Acione [no evento `pull_request_target`](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#pull_request_target).
2. Fa√ßa o checkout da branch PR.
3. Execute e acompanhe seus benchmarks do PR usando `bencher run` diretamente.

Isso funciona porque `pull_request_target` √© executado no contexto da branch alvo da pull request,
onde segredos como `BENCHER_API_TOKEN` e `GITHUB_TOKEN` est√£o dispon√≠veis.
Portanto, esta workflow s√≥ ser√° executada se existir na branch alvo.
Evite definir quaisquer segredos como vari√°veis de ambiente, como `BENCHER_API_TOKEN`.
Em vez disso, passe explicitamente o token da API para `bencher run` (ex: `--token ${{ secrets.BENCHER_API_TOKEN }}`).
Veja este [artigo do GitHub Security Lab](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/)
e [este post de blog](https://nathandavison.com/blog/github-actions-and-the-threat-of-malicious-pull-requests)
sobre a preven√ß√£o de solicita√ß√µes pwn para uma vis√£o completa.

<GitHubActions3 />

### Armazenar Resultados do Benchmark da PR

1. Execute seus benchmarks do PR em eventos `pull_request`.
1. Salve os resultados do benchmarks do PR em um arquivo e carregue-os como um artefato.
1. Carregue o evento do PR como um artefato.
1. Encadeie essa workflow com [o evento `workflow_run`](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#workflow_run).
1. Extraia os dados necess√°rios do evento do PR armazenado.
1. Acompanhe os resultados do benchmark do PR armazenados com `bencher run`.

Isso funciona porque `workflow_run` √© executado dentro do contexto da branch padr√£o do reposit√≥rio,
onde segredos como `BENCHER_API_TOKEN` e `GITHUB_TOKEN` est√£o dispon√≠veis.
Portanto, essas workflows s√≥ ser√£o executadas se existirem na branch padr√£o.
Veja [usando dados da workflow que acionou](https://docs.github.com/pt/actions/using-workflows/events-that-trigger-workflows#using-data-from-the-triggering-workflow) para uma vis√£o completa. 
O n√∫mero da pull request, a branch de cabe√ßa e a branch base usados na workflow inicial devem ser explicitamente passados, pois eles n√£o est√£o dispon√≠veis dentro de `workflow_run`.

<GitHubActions4 />

<br/>
<br/>

> üê∞ Parab√©ns! Voc√™ aprendeu como usar o Bencher nas GitHub Actions! üéâ

<br/>

<h2><a href="/docs/pt/explanation/benchmarking">Continue: Vis√£o Geral de Benchmark ‚û°</a></h2>